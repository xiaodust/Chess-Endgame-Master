<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中国象棋 - 游戏主页</title>
    <style>
        /* 全局设置 */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            font-family: "KaiTi", "STKaiti", "Microsoft YaHei", serif; /* 楷体优先 */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }

        /* 背景大字装饰 */
        .bg-watermark {
            position: absolute;
            font-size: 50vh;
            color: rgba(255, 255, 255, 0.03);
            font-weight: bold;
            pointer-events: none;
            z-index: 0;
            font-family: "LiSu", "KaiTi", serif;
        }

        /* 主容器 */
        .menu-container {
            position: relative;
            z-index: 10;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
        }

        /* 标题样式 */
        .game-title {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .title-text {
            font-size: 5rem;
            font-weight: bold;
            /* 金色渐变文字 */
            background: linear-gradient(to bottom, #ffd700, #e6b800);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            /* 模拟文字阴影/浮雕效果 */
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
            letter-spacing: 0.5rem;
            margin: 0;
        }

        .subtitle-text {
            font-size: 1.2rem;
            color: #888;
            letter-spacing: 0.5rem;
            margin-top: 10px;
            font-family: sans-serif;
            text-transform: uppercase;
        }

        /* 按钮组容器 */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 2vh;
            width: clamp(240px, 28vw, 380px);
        }

        /* 按钮通用样式 */
        .btn {
            position: relative;
            width: 100%;
            padding: 2vh 0;
            font-size: clamp(1.2rem, 2.4vh, 1.6rem);
            font-weight: bold;
            color: white;
            border: 4px solid transparent; /* 预留边框位置 */
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            /* 立体阴影 */
            box-shadow: 0 6px 0 rgba(0,0,0,0.4), 0 10px 10px rgba(0,0,0,0.3);
            transition: all 0.1s ease;
            outline: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* 按钮点击效果 */
        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.4), 0 4px 4px rgba(0,0,0,0.3);
        }

        .btn:hover, .btn:focus {
            filter: brightness(1.2);
            transform: scale(1.05);
            border-color: #fff; /* 选中时显示白色边框 */
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5), 0 6px 0 rgba(0,0,0,0.4);
            z-index: 1;
        }

        /* 红色按钮 (主功能) */
        .btn-red {
            background: linear-gradient(180deg, #d32f2f 0%, #b71c1c 100%);
            border-top: 1px solid #ef5350;
        }

        /* 蓝色/灰色按钮 (次要功能) */
        .btn-blue {
            background: linear-gradient(180deg, #37474f 0%, #263238 100%);
            border-top: 1px solid #546e7a;
        }

        /* 黄色按钮 (设置) */
        .btn-yellow {
            background: linear-gradient(180deg, #fbc02d 0%, #f57f17 100%);
            border-top: 1px solid #fff176;
            color: #3e2723; /* 深褐色文字 */
            text-shadow: none;
        }

        /* 底部版权 */
        .footer {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: #555;
            font-size: 0.8rem;
        }

        .status-banner {
            position: fixed;
            top: 12px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #ffd700;
            font-size: 1rem;
            z-index: 100;
            text-shadow: 0 1px 2px rgba(0,0,0,0.6);
            pointer-events: none;
        }

    </style>
</head>
<body>

    <!-- 背景字 -->
    <div class="bg-watermark">帥</div>

    <div class="menu-container">
        <!-- 标题 -->
        <div class="game-title">
            <h1 class="title-text">中国象棋</h1>
            <div class="subtitle-text">CHINESE CHESS</div>
        </div>

        <!-- 菜单按钮 -->
        <div class="button-group">
            <button class="btn btn-red" onclick="window.location.href='mode_pve.html'">人机对战</button>
            <button class="btn btn-blue" onclick="window.location.href='mode_endgame.html'">残局闯关</button>
            <button class="btn btn-blue" onclick="window.location.href='mode_pvp.html'">双人对弈</button>
            <button class="btn btn-yellow" onclick="openSettings()">游戏设置</button>
        </div>
    </div>

    <div class="footer">v1.0.0 Powered by YourGameEngine</div>
    <div id="auth-status" class="status-banner"></div>

    <script>
        async function ping(base){
            try{
                const ctl = new AbortController();
                const t = setTimeout(()=>ctl.abort(), 2500);
                const r = await fetch(`${base}/api/user/ping`, {method:'GET', signal: ctl.signal});
                clearTimeout(t);
                return r && r.ok;
            }catch(e){ return false; }
        }
        async function pickApiBase(){
            const param = new URLSearchParams(location.search).get('api');
            const cached = localStorage.getItem('apiBase');
            const cands = [];
            if(param) cands.push(param);
            if(cached) cands.push(cached);
            cands.push('http://10.0.2.2:8080','http://localhost:8080');
            for(const base of cands){
                setStatus(`探测后端：${base}`);
                if(await ping(base)) { localStorage.setItem('apiBase', base); return base; }
            }
            return cands[0] || 'http://10.0.2.2:8080';
        }
        async function openSettings(){
            const saved = localStorage.getItem('auth');
            if(!saved){ setStatus('未登录'); return; }
            try{
                const info = JSON.parse(saved);
                alert(`当前账号\n用户名：${info.username}\n密码：${info.password}`);
            }catch(e){ setStatus('未登录'); }
        }
        function setStatus(t){ const el = document.getElementById('auth-status'); if(el){ el.textContent = t; el.style.display = 'block'; } }
        async function getDeviceId(){
            let id = localStorage.getItem('deviceId');
            if(id) return id;
            try{
                if(window.Android && typeof window.Android.getDeviceId === 'function'){
                    id = window.Android.getDeviceId();
                } else if(window.Device && typeof window.Device.getId === 'function'){
                    id = window.Device.getId();
                } else {
                    id = 'tv-' + (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
                }
            }catch(e){
                id = 'tv-' + (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
            }
            localStorage.setItem('deviceId', id);
            return id;
        }
        async function ensureLogin(){
            const saved = localStorage.getItem('auth');
            if(saved){
                try{
                    const info = JSON.parse(saved);
                    setStatus(`已登录：${info.username}`);
                }catch(e){ setStatus('已登录'); }
                return;
            }
            const base = await pickApiBase();
            setStatus(`后端地址：${base}`);
            const deviceId = await getDeviceId();
            setStatus('正在连接后端...');
            let regRes = null;
            try{
                regRes = await fetch(`${base}/api/user/registerByDevice?deviceId=${encodeURIComponent(deviceId)}`, {method: 'POST'}).then(r=>r.json());
            }catch(err){ setStatus(`后端不可达：${String(err)}`); return; }
            if(!regRes){ setStatus('后端不可达'); return; }
            if(!regRes.success || !regRes.data){ setStatus('注册失败'); return; }
            const { username, password } = regRes.data;
            setStatus('注册完成，正在登录...');
            let loginRes = null;
            try{
                loginRes = await fetch(`${base}/api/user/login?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`, {method: 'POST'}).then(r=>r.json());
            }catch(err){ setStatus(`登录失败：${String(err)}`); return; }
            if(loginRes && loginRes.success){
                localStorage.setItem('auth', JSON.stringify({username, password, user: loginRes.data}));
                localStorage.setItem('apiBase', base);
                setStatus('登录成功');
            } else {
                setStatus('登录失败');
            }
        }
        window.onload = async function() {
            setStatus('正在检测登录状态...');
            await ensureLogin();
            try{
                const base = localStorage.getItem('apiBase') || 'http://10.0.2.2:8080';
                setupChessWS(base);
            }catch(e){
                setStatus('WS 连接初始化失败');
            }
            const firstBtn = document.querySelector('.btn');
            if(firstBtn) firstBtn.focus();
        };

        function setupChessWS(base){
            let ws = null;
            let retry = 0;
            const maxRetry = 5;
            const toWsUrl = (b)=>{
                try{ const u = new URL(b); const proto = u.protocol === 'https:' ? 'wss:' : 'ws:'; return `${proto}//${u.host}/ws/tv`; }catch(e){ return `ws://localhost:8080/ws/tv`; }
            };
            const url = toWsUrl(base);
            setStatus(`连接 WS：${url}`);
            const pending = [];
            const subscribers = [];
            function connect(){
                try{
                    ws = new WebSocket(url);
                    ws.onopen = ()=>{ retry = 0; setStatus('WS 已连接');
                        try{ while(pending.length){ ws.send(pending.shift()); } }catch(e){}
                    };
                    ws.onclose = ()=>{ setStatus('WS 已断开'); if(retry < maxRetry){ retry++; setTimeout(connect, 1000 * retry); } };
                    ws.onerror = ()=>{ setStatus('WS 错误'); };
                    ws.onmessage = (ev)=>{
                        try{
                            const data = JSON.parse(ev.data);
                            if(data.type === 'round_summary'){
                                if(data.status === 'pending') setStatus('AI评估中...');
                                else setStatus('AI评估完成');
                            }else if(data.type === 'error'){
                                setStatus(`WS错误：${data.message || '未知错误'}`);
                            }else{
                                console.log('WS_MESSAGE', data);
                            }
                            try{ subscribers.forEach(fn=>fn(data)); }catch(e){}
                        }catch(err){ console.log('WS_MESSAGE_TEXT', ev.data); }
                    };
                }catch(e){ setStatus('WS 连接失败'); }
            }
            connect();
            window.ChessWS = {
                
                ready(){ return ws && ws.readyState === WebSocket.OPEN; },
                subscribe(fn){ subscribers.push(fn); }
                ,sendRoundSummary(payload){
                    const msg = JSON.stringify(Object.assign({type:'round_summary'}, payload || {}));
                    if(ws && ws.readyState === WebSocket.OPEN){ ws.send(msg); }
                    else { pending.push(msg); }
                }
            };
        }
    </script>
</body>
</html>
